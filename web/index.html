<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiro API Proxy</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f0f4ff 0%, #faf5ff 100%); padding: 16px; }
        .login-box { background: #fff; padding: 32px 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 380px; }
        .login-box h1 { text-align: center; color: #7c3aed; margin-bottom: 8px; font-size: 22px; justify-content: center; }
        .login-box p { text-align: center; color: #64748b; margin-bottom: 24px; font-size: 14px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; color: #374151; font-size: 14px; font-weight: 500; }
        input[type="text"], input[type="password"], select, textarea { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; background: #fff; color: #1e293b; -webkit-appearance: none; }
        input:focus, textarea:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
        textarea { resize: vertical; min-height: 100px; font-family: monospace; font-size: 14px; }
        .btn { padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; touch-action: manipulation; }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover, .btn-primary:active { background: #6d28d9; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #f1f5f9; color: #374151; }
        .btn-sm { padding: 8px 12px; font-size: 13px; }
        .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 16px; font-weight: 600; }
        .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #fff; border-radius: 10px; padding: 12px 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 20px; font-weight: 700; color: #7c3aed; }
        .stat-label { font-size: 11px; color: #64748b; margin-top: 2px; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; white-space: nowrap; }
        .badge-success { background: #dcfce7; color: #16a34a; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-error { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #ede9fe; color: #7c3aed; }
        .badge-pro { background: #3b82f6; color: white; }
        .badge-proplus { background: #8b5cf6; color: white; }
        .badge-power { background: #f59e0b; color: white; }
        .badge-free { background: #6b7280; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; padding: 16px; overflow-y: auto; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; padding-top: 5vh; }
        .modal-content { background: #fff; border-radius: 12px; padding: 20px; width: 100%; max-width: 600px; margin-bottom: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; padding: 0 8px; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #cbd5e1; border-radius: 24px; transition: 0.3s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .slider { background: #7c3aed; }
        input:checked + .slider:before { transform: translateX(20px); }
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; background: #f1f5f9; padding: 4px; border-radius: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { padding: 10px 16px; border-radius: 8px; cursor: pointer; color: #64748b; font-weight: 500; font-size: 14px; white-space: nowrap; flex-shrink: 0; }
        .tab:hover { color: #374151; }
        .tab.active { background: #fff; color: #7c3aed; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; }
        .message-error { background: #fee2e2; color: #dc2626; }
        .endpoint { background: #f8fafc; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px; word-break: break-all; }
        .endpoint span { flex: 1; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; }
        .header h1 { font-size: 18px; color: #7c3aed; }
        .account-card { background: #fff; border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #7c3aed; }
        .account-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
        .account-info { flex: 1; min-width: 0; }
        .account-email { font-weight: 600; font-size: 14px; color: #1e293b; word-break: break-all; }
        .account-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .account-usage { margin: 10px 0; }
        .usage-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
        .usage-fill { height: 100%; background: #7c3aed; border-radius: 3px; transition: width 0.3s; }
        .usage-fill.high { background: #f59e0b; }
        .usage-fill.critical { background: #ef4444; }
        .usage-text { display: flex; justify-content: space-between; font-size: 11px; color: #64748b; margin-top: 4px; }
        .account-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0; }
        .account-stat { text-align: center; }
        .account-stat-value { font-weight: 600; font-size: 13px; }
        .account-stat-label { font-size: 10px; color: #64748b; }
        .account-actions { display: flex; gap: 6px; flex-shrink: 0; flex-wrap: wrap; }
        .detail-section { margin-bottom: 20px; }
        .detail-section h4 { font-size: 13px; color: #64748b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .detail-item { background: #f8fafc; padding: 10px 12px; border-radius: 8px; }
        .detail-label { font-size: 11px; color: #64748b; margin-bottom: 2px; }
        .detail-value { font-size: 13px; font-weight: 500; word-break: break-all; }
        .model-list { display: grid; gap: 8px; max-height: 250px; overflow-y: auto; }
        .model-item { background: #f8fafc; padding: 10px 12px; border-radius: 8px; }
        .model-name { font-weight: 500; font-size: 13px; }
        .model-info { font-size: 11px; color: #64748b; margin-top: 2px; }
        .btn-icon { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; }
        .btn-icon svg { width: 18px; height: 18px; }
        .loading { opacity: 0.6; pointer-events: none; }
        .logo { display: flex; align-items: center; gap: 8px; }
        .logo svg { width: 24px; height: 24px; color: #7c3aed; }
        .machine-id-row { display: flex; gap: 8px; align-items: stretch; flex-wrap: wrap; }
        .machine-id-row input { flex: 1; min-width: 200px; font-family: monospace; font-size: 11px; }
        .machine-id-row .btn { flex-shrink: 0; }
        
        /* 移动端适配 */
        @media (max-width: 640px) {
            .container { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-card { padding: 10px 6px; }
            .stat-value { font-size: 18px; }
            .stat-label { font-size: 10px; }
            .card { padding: 14px; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-actions { width: 100%; }
            .card-actions .btn { flex: 1; text-align: center; }
            .account-header { flex-direction: column; }
            .account-actions { width: 100%; justify-content: flex-start; }
            .account-actions .btn { padding: 8px 10px; font-size: 12px; }
            .account-stats { grid-template-columns: repeat(2, 1fr); }
            .detail-grid { grid-template-columns: 1fr; }
            .tabs { gap: 2px; }
            .tab { padding: 10px 12px; font-size: 13px; }
            .modal-content { padding: 16px; }
            .endpoint { flex-direction: column; align-items: stretch; }
            .endpoint .btn { width: 100%; }
            .machine-id-row { flex-direction: column; }
            .machine-id-row input { min-width: 100%; }
            .machine-id-row .btn { width: 100%; }
        }
        
        @media (min-width: 641px) {
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <h1 class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Kiro API Proxy</h1>
            <p>请输入管理密码登录</p>
            <div class="form-group">
                <label>管理密码</label>
                <input type="password" id="pwdField" placeholder="输入密码" autocomplete="off">
            </div>
            <button type="button" class="btn btn-primary" style="width:100%" onclick="login()">登录</button>
            <div id="loginError" class="message message-error hidden" style="margin-top:12px"></div>
        </div>
    </div>

    <div id="mainPage" class="container hidden">
        <div class="header">
            <h1 class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Kiro API Proxy</h1>
            <span class="badge badge-success" id="statusBadge">运行中</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="statAccounts">0</div><div class="stat-label">账号</div></div>
            <div class="stat-card"><div class="stat-value" id="statRequests">0</div><div class="stat-label">请求</div></div>
            <div class="stat-card"><div class="stat-value" id="statSuccess">0</div><div class="stat-label">成功</div></div>
            <div class="stat-card"><div class="stat-value" id="statFailed">0</div><div class="stat-label">失败</div></div>
            <div class="stat-card"><div class="stat-value" id="statTokens">0</div><div class="stat-label">Tokens</div></div>
            <div class="stat-card"><div class="stat-value" id="statCredits">0</div><div class="stat-label">Credits</div></div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="accounts">账号</div>
            <div class="tab" data-tab="settings">设置</div>
            <div class="tab" data-tab="api">API</div>
        </div>

        <div id="tabAccounts" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">账号列表</span>
                    <div class="card-actions">
                        <button class="btn btn-primary btn-sm" onclick="showModal('add')">添加账号</button>
                    </div>
                </div>
                <div id="accountsList"></div>
            </div>
        </div>

        <div id="tabSettings" class="tab-content hidden">
            <div class="card">
                <div class="card-header"><span class="card-title">API 设置</span></div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:10px">
                        <label class="switch"><input type="checkbox" id="requireApiKey"><span class="slider"></span></label>
                        启用 API Key 验证
                    </label>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="apiKeyInput" placeholder="留空则不验证">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">管理密码</span></div>
                <div class="form-group">
                    <label>新密码</label>
                    <input type="password" id="newPassword" placeholder="输入新密码">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">修改密码</button>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">统计</span></div>
                <button class="btn btn-danger" onclick="resetStats()">重置统计</button>
            </div>
        </div>

        <div id="tabApi" class="tab-content hidden">
            <div class="card">
                <div class="card-header"><span class="card-title">API 端点</span></div>
                <p style="margin-bottom:10px;font-weight:500;font-size:14px">Claude API</p>
                <div class="endpoint"><span id="claudeEndpoint"></span><button class="btn btn-sm btn-secondary" onclick="copy('claudeEndpoint')">复制</button></div>
                <p style="margin:14px 0 10px;font-weight:500;font-size:14px">OpenAI API</p>
                <div class="endpoint"><span id="openaiEndpoint"></span><button class="btn btn-sm btn-secondary" onclick="copy('openaiEndpoint')">复制</button></div>
                <p style="margin:14px 0 10px;font-weight:500;font-size:14px">模型列表</p>
                <div class="endpoint"><span id="modelsEndpoint"></span><button class="btn btn-sm btn-secondary" onclick="copy('modelsEndpoint')">复制</button></div>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">添加账号</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">账号详情</span>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="detailBody"></div>
        </div>
    </div>

    <script>
        let password = localStorage.getItem('admin_password') || '';
        const baseUrl = location.origin;
        let accountsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (password) tryAutoLogin();
            document.getElementById('pwdField').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
            document.querySelectorAll('.tab').forEach(tab => { tab.onclick = () => switchTab(tab.dataset.tab); });
        });

        async function tryAutoLogin() {
            try {
                const res = await fetch('/admin/api/status', { headers: { 'X-Admin-Password': password } });
                if (res.ok) { showMain(); loadData(); }
            } catch (e) {}
        }

        async function login() {
            password = document.getElementById('pwdField').value;
            try {
                const res = await fetch('/admin/api/status', { headers: { 'X-Admin-Password': password } });
                if (res.ok) {
                    localStorage.setItem('admin_password', password);
                    showMain(); loadData();
                } else {
                    document.getElementById('loginError').textContent = '密码错误';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loginError').textContent = '连接失败';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function showMain() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
        }

        async function loadData() {
            await Promise.all([loadStats(), loadAccounts(), loadSettings()]);
            document.getElementById('claudeEndpoint').textContent = baseUrl + '/v1/messages';
            document.getElementById('openaiEndpoint').textContent = baseUrl + '/v1/chat/completions';
            document.getElementById('modelsEndpoint').textContent = baseUrl + '/v1/models';
        }

        async function loadStats() {
            const res = await fetch('/admin/api/status', { headers: { 'X-Admin-Password': password } });
            const d = await res.json();
            document.getElementById('statAccounts').textContent = d.accounts || 0;
            document.getElementById('statRequests').textContent = d.totalRequests || 0;
            document.getElementById('statSuccess').textContent = d.successRequests || 0;
            document.getElementById('statFailed').textContent = d.failedRequests || 0;
            document.getElementById('statTokens').textContent = formatNum(d.totalTokens || 0);
            document.getElementById('statCredits').textContent = (d.totalCredits || 0).toFixed(1);
        }

        async function loadAccounts() {
            const res = await fetch('/admin/api/accounts', { headers: { 'X-Admin-Password': password } });
            accountsData = await res.json();
            renderAccounts();
        }

        function renderAccounts() {
            const container = document.getElementById('accountsList');
            if (accountsData.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#64748b;padding:30px">暂无账号</p>';
                return;
            }
            container.innerHTML = accountsData.map(a => {
                const usagePercent = (a.usagePercent || 0) * 100;
                const usageClass = usagePercent > 90 ? 'critical' : usagePercent > 70 ? 'high' : '';
                return `<div class="account-card">
                    <div class="account-header">
                        <div class="account-info">
                            <div class="account-email">${a.email || a.id.substring(0,12)+'...'}</div>
                            <div class="account-meta">
                                ${getSubBadge(a.subscriptionType)}
                                <span class="badge badge-info">${formatAuthMethod(a.provider || a.authMethod)}</span>
                                ${getStatusBadge(a)}
                            </div>
                        </div>
                        <div class="account-actions">
                            <button class="btn btn-sm btn-icon btn-secondary" onclick="refreshAccount('${a.id}')" title="刷新"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg></button>
                            <button class="btn btn-sm btn-icon btn-secondary" onclick="showDetail('${a.id}')" title="详情"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
                            <button class="btn btn-sm ${a.enabled ? 'btn-secondary' : 'btn-primary'}" onclick="toggleAccount('${a.id}',${!a.enabled})">${a.enabled ? '禁用' : '启用'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAccount('${a.id}')">删除</button>
                        </div>
                    </div>
                    ${a.usageLimit > 0 ? `<div class="account-usage">
                        <div class="usage-bar"><div class="usage-fill ${usageClass}" style="width:${usagePercent}%"></div></div>
                        <div class="usage-text">
                            <span>${a.usageCurrent?.toFixed(1) || 0} / ${a.usageLimit?.toFixed(0) || 0}</span>
                            <span>${usagePercent.toFixed(1)}%</span>
                        </div>
                    </div>` : ''}
                    <div class="account-stats">
                        <div class="account-stat"><div class="account-stat-value">${a.requestCount || 0}</div><div class="account-stat-label">请求</div></div>
                        <div class="account-stat"><div class="account-stat-value">${formatNum(a.totalTokens || 0)}</div><div class="account-stat-label">Tokens</div></div>
                        <div class="account-stat"><div class="account-stat-value">${(a.totalCredits || 0).toFixed(1)}</div><div class="account-stat-label">Credits</div></div>
                        <div class="account-stat"><div class="account-stat-value">${formatTokenExpiry(a.expiresAt)}</div><div class="account-stat-label">到期</div></div>
                    </div>
                </div>`;
            }).join('');
        }

        function getSubBadge(type) {
            const t = (type || '').toUpperCase();
            if (t.includes('POWER')) return '<span class="badge badge-power">POWER</span>';
            if (t.includes('PRO_PLUS') || t.includes('PROPLUS')) return '<span class="badge badge-proplus">PRO+</span>';
            if (t.includes('PRO')) return '<span class="badge badge-pro">PRO</span>';
            return '<span class="badge badge-free">FREE</span>';
        }

        function formatAuthMethod(method) {
            if (!method) return '-';
            if (method === 'idc') return 'Enterprise';
            if (method === 'social') return 'Social';
            return method;
        }

        function getStatusBadge(a) {
            if (!a.hasToken) return '<span class="badge badge-error">无Token</span>';
            if (a.expiresAt && a.expiresAt < Date.now()/1000) return '<span class="badge badge-warning">已过期</span>';
            if (!a.enabled) return '<span class="badge badge-warning">已禁用</span>';
            return '<span class="badge badge-success">正常</span>';
        }

        function formatTokenExpiry(ts) {
            if (!ts) return '-';
            const diff = ts - Date.now()/1000;
            if (diff <= 0) return '已过期';
            if (diff < 3600) return Math.floor(diff/60) + '分钟';
            if (diff < 86400) return Math.floor(diff/3600) + '小时';
            return Math.floor(diff/86400) + '天';
        }

        async function refreshAccount(id) {
            const card = event.target.closest('.account-card');
            if (card) card.classList.add('loading');
            try {
                const res = await fetch('/admin/api/accounts/' + id + '/refresh', { method: 'POST', headers: { 'X-Admin-Password': password } });
                const d = await res.json();
                if (d.success) { loadAccounts(); } else { alert('刷新失败: ' + d.error); }
            } catch (e) { alert('刷新失败'); }
            if (card) card.classList.remove('loading');
        }

        async function showDetail(id) {
            const a = accountsData.find(x => x.id === id);
            if (!a) return;
            document.getElementById('detailBody').innerHTML = `
                <div class="detail-section">
                    <h4>基本信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="detail-label">邮箱</div><div class="detail-value">${a.email || '-'}</div></div>
                        <div class="detail-item"><div class="detail-label">用户ID</div><div class="detail-value">${a.userId || '-'}</div></div>
                        <div class="detail-item"><div class="detail-label">认证方式</div><div class="detail-value">${formatAuthMethod(a.provider || a.authMethod)}</div></div>
                        <div class="detail-item"><div class="detail-label">Region</div><div class="detail-value">${a.region || 'us-east-1'}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>机器码</h4>
                    <div class="machine-id-row">
                        <input type="text" id="machineIdInput" value="${a.machineId || ''}" placeholder="UUID格式">
                        <button class="btn btn-sm btn-secondary" onclick="generateMachineId()">生成</button>
                        <button class="btn btn-sm btn-primary" onclick="saveMachineId('${id}')">保存</button>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>订阅信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="detail-label">订阅类型</div><div class="detail-value">${a.subscriptionTitle || a.subscriptionType || '-'}</div></div>
                        <div class="detail-item"><div class="detail-label">Token到期</div><div class="detail-value">${a.expiresAt ? new Date(a.expiresAt*1000).toLocaleString() : '-'}</div></div>
                        <div class="detail-item"><div class="detail-label">用量</div><div class="detail-value">${a.usageCurrent?.toFixed(1) || 0} / ${a.usageLimit?.toFixed(0) || 0}</div></div>
                        <div class="detail-item"><div class="detail-label">重置日期</div><div class="detail-value">${a.nextResetDate || '-'}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>统计</h4>
                    <div class="detail-grid">
                        <div class="detail-item"><div class="detail-label">请求数</div><div class="detail-value">${a.requestCount || 0}</div></div>
                        <div class="detail-item"><div class="detail-label">错误数</div><div class="detail-value">${a.errorCount || 0}</div></div>
                        <div class="detail-item"><div class="detail-label">总Tokens</div><div class="detail-value">${formatNum(a.totalTokens || 0)}</div></div>
                        <div class="detail-item"><div class="detail-label">总Credits</div><div class="detail-value">${(a.totalCredits || 0).toFixed(2)}</div></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>可用模型 <button class="btn btn-sm btn-secondary" onclick="loadModels('${id}')" style="margin-left:8px">加载</button></h4>
                    <div id="modelsList" class="model-list"><p style="color:#64748b;font-size:12px">点击加载按钮获取</p></div>
                </div>`;
            document.getElementById('detailModal').classList.add('active');
        }

        async function loadModels(id) {
            const container = document.getElementById('modelsList');
            container.innerHTML = '<p style="color:#64748b">加载中...</p>';
            try {
                const res = await fetch('/admin/api/accounts/' + id + '/models', { headers: { 'X-Admin-Password': password } });
                const d = await res.json();
                if (d.success && d.models) {
                    container.innerHTML = d.models.map(m => `<div class="model-item"><div class="model-name">${m.modelId}</div><div class="model-info">${m.description || ''}</div></div>`).join('') || '<p style="color:#64748b">无可用模型</p>';
                } else {
                    container.innerHTML = '<p style="color:#ef4444">加载失败: ' + (d.error || '未知错误') + '</p>';
                }
            } catch (e) { container.innerHTML = '<p style="color:#ef4444">加载失败</p>'; }
        }

        function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }

        async function generateMachineId() {
            try {
                const res = await fetch('/admin/api/generate-machine-id', { headers: { 'X-Admin-Password': password } });
                const d = await res.json();
                if (d.machineId) document.getElementById('machineIdInput').value = d.machineId;
            } catch (e) { alert('生成失败'); }
        }

        async function saveMachineId(id) {
            const machineId = document.getElementById('machineIdInput').value.trim();
            if (machineId && !/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(machineId) && !/^[0-9a-f]{32}$/i.test(machineId)) {
                alert('机器码格式错误'); return;
            }
            try {
                const res = await fetch('/admin/api/accounts/' + id, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                    body: JSON.stringify({ machineId })
                });
                const d = await res.json();
                if (d.success) { alert('已保存'); loadAccounts(); } else { alert('保存失败: ' + d.error); }
            } catch (e) { alert('保存失败'); }
        }

        async function loadSettings() {
            const res = await fetch('/admin/api/settings', { headers: { 'X-Admin-Password': password } });
            const d = await res.json();
            document.getElementById('requireApiKey').checked = d.requireApiKey;
            document.getElementById('apiKeyInput').value = d.apiKey || '';
        }

        async function saveSettings() {
            await fetch('/admin/api/settings', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify({ requireApiKey: document.getElementById('requireApiKey').checked, apiKey: document.getElementById('apiKeyInput').value })
            });
            alert('已保存');
        }

        async function changePassword() {
            const newPwd = document.getElementById('newPassword').value;
            if (!newPwd) return alert('请输入新密码');
            await fetch('/admin/api/settings', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify({ password: newPwd })
            });
            password = newPwd;
            localStorage.setItem('admin_password', password);
            alert('密码已修改');
            document.getElementById('newPassword').value = '';
        }

        async function resetStats() {
            if (!confirm('确定重置统计？')) return;
            await fetch('/admin/api/stats/reset', { method: 'POST', headers: { 'X-Admin-Password': password } });
            loadStats();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
        }

        async function toggleAccount(id, enabled) {
            await fetch('/admin/api/accounts/' + id, {
                method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify({ enabled })
            });
            loadAccounts();
        }

        async function deleteAccount(id) {
            if (!confirm('确定删除？')) return;
            await fetch('/admin/api/accounts/' + id, { method: 'DELETE', headers: { 'X-Admin-Password': password } });
            loadAccounts(); loadStats();
        }

        function formatNum(n) {
            if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n/1000).toFixed(1) + 'K';
            return n.toString();
        }

        function copy(id) {
            navigator.clipboard.writeText(document.getElementById(id).textContent);
            alert('已复制');
        }

        function showModal(type) {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            if (type === 'add') {
                title.textContent = '添加账号';
                body.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:12px">
                        <div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s" onclick="showModal('builderid')" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-weight:600;margin-bottom:6px">AWS Builder ID</div>
                            <div style="font-size:13px;color:#64748b">通过 AWS Builder ID 授权登录添加个人账号</div>
                        </div>
                        <div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s" onclick="showModal('iam')" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-weight:600;margin-bottom:6px">IAM Identity Center (企业 SSO) 登录</div>
                            <div style="font-size:13px;color:#64748b">通过 IAM Identity Center (企业 SSO) 授权添加企业账号</div>
                        </div>
                        <div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s" onclick="showModal('sso')" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-weight:600;margin-bottom:6px">SSO Token</div>
                            <div style="font-size:13px;color:#64748b">通过浏览器 x-amz-sso_authn Token 添加账号</div>
                        </div>
                        <div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s" onclick="showModal('local')" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-weight:600;margin-bottom:6px">Kiro 本地缓存</div>
                            <div style="font-size:13px;color:#64748b">通过 Kiro IDE 本地缓存文件添加账号</div>
                        </div>
                        <div class="card" style="margin:0;cursor:pointer;border:2px solid transparent;transition:border-color 0.2s" onclick="showModal('credentials')" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='transparent'">
                            <div style="font-weight:600;margin-bottom:6px">凭证 JSON</div>
                            <div style="font-size:13px;color:#64748b">通过 Kiro Account Manager 导出的凭证添加账号</div>
                        </div>
                    </div>
                    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">取消</button></div>`;
            } else if (type === 'builderid') {
                title.textContent = 'AWS Builder ID';
                body.innerHTML = `
                    <p style="font-size:13px;color:#64748b;margin-bottom:16px">通过 AWS Builder ID 授权登录添加个人账号</p>
                    <div id="builderIdStep1">
                        <div class="form-group">
                            <label>Region</label>
                            <input type="text" id="builderIdRegion" value="us-east-1">
                        </div>
                        <div class="modal-footer"><button class="btn btn-secondary" onclick="showModal('add')">返回</button><button class="btn btn-primary" onclick="startBuilderIdLogin()">开始登录</button></div>
                    </div>
                    <div id="builderIdStep2" class="hidden">
                        <div class="message" style="background:#ede9fe;color:#7c3aed;text-align:center">
                            <p style="font-size:18px;font-weight:600;margin-bottom:8px" id="builderIdUserCode"></p>
                            <p style="font-size:12px">请在浏览器中输入上方验证码</p>
                        </div>
                        <div class="form-group" style="margin-top:16px">
                            <label>验证链接</label>
                            <div class="endpoint" style="margin-bottom:0"><span id="builderIdVerifyUrl" style="font-size:12px"></span></div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="window.open(document.getElementById('builderIdVerifyUrl').textContent,'_blank')">打开</button>
                                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="navigator.clipboard.writeText(document.getElementById('builderIdVerifyUrl').textContent);alert('已复制')">复制</button>
                            </div>
                        </div>
                        <p id="builderIdStatus" style="color:#64748b;margin:16px 0;font-size:13px;text-align:center">等待授权中...</p>
                        <div class="modal-footer"><button class="btn btn-secondary" onclick="cancelBuilderIdLogin()">取消</button></div>
                    </div>`;
            } else if (type === 'local') {
                title.textContent = 'Kiro 本地缓存';
                body.innerHTML = `
                    <p style="font-size:13px;color:#64748b;margin-bottom:16px">通过 Kiro IDE 本地缓存文件添加账号</p>
                    <div style="font-size:13px;color:#64748b;margin-bottom:16px;line-height:1.6">
                        <p style="margin-bottom:8px"><b>文件位置</b></p>
                        <p style="margin-bottom:4px">Windows: <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:11px">%USERPROFILE%\\.aws\\sso\\cache\\</code></p>
                        <p>macOS/Linux: <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:11px">~/.aws/sso/cache/</code></p>
                    </div>
                    <div class="form-group">
                        <label>登录渠道</label>
                        <select id="localProvider" onchange="updateLocalFields()">
                            <option value="BuilderId">AWS Builder ID</option>
                            <option value="Enterprise">IAM Identity Center (企业 SSO)</option>
                            <option value="Google">Google</option>
                            <option value="Github">GitHub</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>kiro-auth-token.json <span style="font-weight:normal;color:#64748b;font-size:12px">*必填</span></label>
                        <div style="display:flex;gap:8px;align-items:stretch">
                            <textarea id="localTokenJson" placeholder='粘贴文件内容或上传文件' style="flex:1;min-height:80px;font-size:12px"></textarea>
                            <label class="btn btn-secondary" style="display:flex;align-items:center;cursor:pointer">
                                上传<input type="file" accept=".json" style="display:none" onchange="loadLocalFile(this,'localTokenJson')">
                            </label>
                        </div>
                    </div>
                    <div id="localClientGroup" class="form-group">
                        <label>{hash}.json <span style="font-weight:normal;color:#64748b;font-size:12px">*IdC 登录必填</span></label>
                        <div style="display:flex;gap:8px;align-items:stretch">
                            <textarea id="localClientJson" placeholder='粘贴文件内容或上传文件' style="flex:1;min-height:80px;font-size:12px"></textarea>
                            <label class="btn btn-secondary" style="display:flex;align-items:center;cursor:pointer">
                                上传<input type="file" accept=".json" style="display:none" onchange="loadLocalFile(this,'localClientJson')">
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer"><button class="btn btn-secondary" onclick="showModal('add')">返回</button><button class="btn btn-primary" onclick="importLocalKiro()">添加</button></div>`;
            } else if (type === 'credentials') {
                title.textContent = '凭证 JSON';
                body.innerHTML = `
                    <p style="font-size:13px;color:#64748b;margin-bottom:16px">通过 Kiro Account Manager 导出的凭证添加账号</p>
                    <div class="form-group"><label>凭证 JSON</label><textarea id="credJson" placeholder='{"refreshToken":"...","clientId":"...","clientSecret":"..."}'></textarea></div>
                    <div class="form-group">
                        <label>认证方式 <span style="font-weight:normal;color:#64748b;font-size:12px">*影响 Token 刷新方式</span></label>
                        <select id="credAuth">
                            <option value="social">Social (AWS Builder ID / Google / GitHub)</option>
                            <option value="idc">IAM Identity Center (企业 SSO)</option>
                        </select>
                    </div>
                    <div class="modal-footer"><button class="btn btn-secondary" onclick="showModal('add')">返回</button><button class="btn btn-primary" onclick="importCredentials()">添加</button></div>`;
            } else if (type === 'sso') {
                title.textContent = 'SSO Token';
                body.innerHTML = `
                    <div style="font-size:13px;color:#64748b;margin-bottom:16px;line-height:1.6">
                        <p style="margin-bottom:8px"><b>如何获取 Token?</b></p>
                        <ol style="margin:0;padding-left:20px">
                            <li>在浏览器中访问并登录 <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">view.awsapps.com/start</code></li>
                            <li>按 F12 打开开发者工具 → Application → Cookies</li>
                            <li>找到并复制 <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">x-amz-sso_authn</code> 的值</li>
                        </ol>
                    </div>
                    <div class="form-group"><label>x-amz-sso_authn <span style="font-weight:normal;color:#64748b;font-size:12px">*支持批量导入，每行一个 Token</span></label><textarea id="ssoToken" placeholder="粘贴 x-amz-sso_authn 值" style="min-height:120px"></textarea></div>
                    <div class="form-group"><label>Region</label><input type="text" id="ssoRegion" value="us-east-1"></div>
                    <div class="modal-footer"><button class="btn btn-secondary" onclick="showModal('add')">返回</button><button class="btn btn-primary" onclick="importSsoToken()">添加</button></div>`;
            } else if (type === 'iam') {
                title.textContent = 'IAM Identity Center (企业 SSO) 登录';
                body.innerHTML = `
                    <p style="font-size:13px;color:#64748b;margin-bottom:16px">通过 IAM Identity Center (企业 SSO) 授权登录添加账号</p>
                    <div class="form-group"><label>Start URL</label><input type="text" id="iamStartUrl" placeholder="https://xxx.awsapps.com/start"></div>
                    <div class="form-group"><label>Region</label><input type="text" id="iamRegion" value="us-east-1"></div>
                    <div id="iamStep2" class="hidden">
                        <div class="form-group">
                            <label>登录链接</label>
                            <div class="endpoint" style="margin-bottom:0"><span id="iamAuthUrl" style="font-size:11px"></span></div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="window.open(document.getElementById('iamAuthUrl').textContent,'_blank')">打开</button>
                                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="navigator.clipboard.writeText(document.getElementById('iamAuthUrl').textContent);alert('已复制')">复制</button>
                            </div>
                        </div>
                        <p style="color:#16a34a;margin:12px 0;font-size:14px">请在浏览器中完成登录，然后粘贴回调 URL</p>
                        <div class="form-group"><label>回调 URL</label><input type="text" id="iamCallback" placeholder="http://127.0.0.1:xxx/?code=..."></div>
                    </div>
                    <div class="modal-footer"><button class="btn btn-secondary" onclick="showModal('add')">返回</button><button class="btn btn-primary" id="iamBtn" onclick="startIamSso()">开始登录</button></div>`;
            }
            modal.classList.add('active');
        }

        function closeModal() { 
            document.getElementById('addModal').classList.remove('active'); 
            iamSession = ''; 
            if (builderIdPollTimer) { clearTimeout(builderIdPollTimer); builderIdPollTimer = null; }
            builderIdSession = '';
        }

        function loadLocalFile(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { document.getElementById(targetId).value = e.target.result; };
            reader.readAsText(file);
        }

        function updateLocalFields() {
            const provider = document.getElementById('localProvider').value;
            const clientGroup = document.getElementById('localClientGroup');
            if (provider === 'Google' || provider === 'Github') {
                clientGroup.style.display = 'none';
            } else {
                clientGroup.style.display = 'block';
            }
        }

        async function importLocalKiro() {
            const provider = document.getElementById('localProvider').value;
            const tokenJson = document.getElementById('localTokenJson').value.trim();
            const clientJson = document.getElementById('localClientJson').value.trim();
            const isSocial = provider === 'Google' || provider === 'Github';

            if (!tokenJson) { alert('请提供 kiro-auth-token.json 内容'); return; }

            let tokenData, clientData;
            try {
                tokenData = JSON.parse(tokenJson);
            } catch { alert('kiro-auth-token.json 格式错误'); return; }

            if (!tokenData.refreshToken) { alert('缺少 refreshToken'); return; }

            if (!isSocial) {
                if (!clientJson) { alert('IdC 登录需要提供 {hash}.json 内容'); return; }
                try {
                    clientData = JSON.parse(clientJson);
                } catch { alert('{hash}.json 格式错误'); return; }
                if (!clientData.clientId || !clientData.clientSecret) { alert('缺少 clientId 或 clientSecret'); return; }
            }

            const payload = {
                refreshToken: tokenData.refreshToken,
                accessToken: tokenData.accessToken || '',
                clientId: clientData?.clientId || '',
                clientSecret: clientData?.clientSecret || '',
                authMethod: isSocial ? 'social' : 'idc',
                provider: provider
            };

            const res = await fetch('/admin/api/auth/credentials', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify(payload)
            });
            const d = await res.json();
            if (d.success) { closeModal(); loadAccounts(); loadStats(); alert('导入成功: ' + (d.account?.email || d.account?.id)); }
            else alert('失败: ' + d.error);
        }

        async function importCredentials() {
            try {
                const json = JSON.parse(document.getElementById('credJson').value);
                json.authMethod = document.getElementById('credAuth').value;
                const res = await fetch('/admin/api/auth/credentials', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                    body: JSON.stringify(json)
                });
                const d = await res.json();
                if (d.success) { closeModal(); loadAccounts(); loadStats(); alert('导入成功: ' + (d.account?.email || d.account?.id)); }
                else alert('失败: ' + d.error);
            } catch (e) { alert('JSON 格式错误'); }
        }

        async function importSsoToken() {
            const res = await fetch('/admin/api/auth/sso-token', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify({ bearerToken: document.getElementById('ssoToken').value, region: document.getElementById('ssoRegion').value })
            });
            const d = await res.json();
            if (d.success) {
                closeModal(); loadAccounts(); loadStats();
                const count = d.accounts?.length || 0;
                const errCount = d.errors?.length || 0;
                let msg = '成功添加 ' + count + ' 个账号';
                if (errCount > 0) msg += '，' + errCount + ' 个失败';
                alert(msg);
            } else alert('失败: ' + d.error);
        }

        let builderIdSession = '';
        let builderIdPollTimer = null;
        
        async function startBuilderIdLogin() {
            const region = document.getElementById('builderIdRegion').value || 'us-east-1';
            const res = await fetch('/admin/api/auth/builderid/start', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                body: JSON.stringify({ region })
            });
            const d = await res.json();
            if (d.sessionId) {
                builderIdSession = d.sessionId;
                document.getElementById('builderIdUserCode').textContent = d.userCode;
                document.getElementById('builderIdVerifyUrl').textContent = d.verificationUri;
                document.getElementById('builderIdStep1').classList.add('hidden');
                document.getElementById('builderIdStep2').classList.remove('hidden');
                // 开始轮询
                pollBuilderIdAuth(d.interval || 5);
            } else alert('失败: ' + d.error);
        }

        function pollBuilderIdAuth(interval) {
            builderIdPollTimer = setTimeout(async () => {
                const res = await fetch('/admin/api/auth/builderid/poll', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                    body: JSON.stringify({ sessionId: builderIdSession })
                });
                const d = await res.json();
                if (d.completed) {
                    closeModal(); loadAccounts(); loadStats();
                    alert('登录成功: ' + (d.account?.email || d.account?.id));
                } else if (d.success && !d.completed) {
                    document.getElementById('builderIdStatus').textContent = '等待授权中...';
                    pollBuilderIdAuth(d.interval || interval);
                } else {
                    alert('失败: ' + d.error);
                    cancelBuilderIdLogin();
                }
            }, interval * 1000);
        }

        function cancelBuilderIdLogin() {
            if (builderIdPollTimer) {
                clearTimeout(builderIdPollTimer);
                builderIdPollTimer = null;
            }
            builderIdSession = '';
            showModal('add');
        }

        let iamSession = '';
        async function startIamSso() {
            if (iamSession) {
                const res = await fetch('/admin/api/auth/iam-sso/complete', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                    body: JSON.stringify({ sessionId: iamSession, callbackUrl: document.getElementById('iamCallback').value })
                });
                const d = await res.json();
                if (d.success) { closeModal(); loadAccounts(); loadStats(); alert('登录成功: ' + (d.account?.email || d.account?.id)); }
                else alert('失败: ' + d.error);
            } else {
                const res = await fetch('/admin/api/auth/iam-sso/start', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Password': password },
                    body: JSON.stringify({ startUrl: document.getElementById('iamStartUrl').value, region: document.getElementById('iamRegion').value })
                });
                const d = await res.json();
                if (d.authorizeUrl) {
                    iamSession = d.sessionId;
                    document.getElementById('iamAuthUrl').textContent = d.authorizeUrl;
                    document.getElementById('iamStep2').classList.remove('hidden');
                    document.getElementById('iamBtn').textContent = '完成登录';
                } else alert('失败: ' + d.error);
            }
        }

        setInterval(() => { if (!document.getElementById('mainPage').classList.contains('hidden')) loadStats(); }, 10000);
    </script>
</body>
</html>